name: Scrap Workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  # schedule:
  #   - cron: '0 * * * *'

jobs:
  run-scraper:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8.18'

      - name: Install dependencies
        run: |
          echo "Listing files in repository"
          ls -la
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            echo "Installing requirements.txt"
            pip install -r requirements.txt
          else
            echo "requirements.txt not found"
            exit 1
          fi
          pip list  # Show installed packages
        shell: bash

      - name: Set environment variables
        env:
          MONGO_COLLECTION: ${{ secrets.MONGO_COLLECTION }}
          MONGO_DB: ${{ secrets.MONGO_DB }}
          MONGO_HOST: ${{ secrets.MONGO_HOST }}
          MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
          MONGO_USER: ${{ secrets.MONGO_USER }}
        run: |
          echo "MONGO_COLLECTION: $MONGO_COLLECTION"
          echo "MONGO_DB: $MONGO_DB"
          echo "MONGO_HOST: $MONGO_HOST"
          echo "MONGO_USER: $MONGO_USER"
          echo "MONGO_PASSWORD_SET: ${MONGO_PASSWORD:+set}"  # Avoid printing password
          if [ -z "$MONGO_COLLECTION" ] || [ -z "$MONGO_DB" ] || [ -z "$MONGO_HOST" ] || [ -z "$MONGO_USER" ] || [ -z "$MONGO_PASSWORD" ]; then
            echo "Error: One or more environment variables are unset"
            exit 1
          fi
          echo "Running main.py"
          python -u main.py || { echo "main.py failed with exit code $?"; exit 1; }
        shell: bash